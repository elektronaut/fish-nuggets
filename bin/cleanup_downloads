#!/usr/bin/env ruby

require 'fileutils'
require 'rubygems'
require 'activesupport'
require 'ruby-growl'

#sleep 2 # Wait for stuff to be added

downloads_path = File.join(ENV['HOME'], "Downloads")
archive_path   = File.join(downloads_path, "Archive")
torrents_path  = File.join(downloads_path, "Torrents/Torrents")

# Ensure there's an archive dir
FileUtils::mkdir_p(archive_path) unless File.exists?(archive_path)

archived_files = []
Dir.entries(downloads_path).reject{|f| f =~ /^\./}.each do |filename|
	unless filename =~ /^(Archive|Torrents)$/
		path = File.join(downloads_path, filename)
		stat = File.stat(path)
		if filename.downcase =~ /\.torrent$/
			# Move torrent files
			FileUtils::mv(path, torrents_path)
		elsif stat.ctime < 7.days.ago
			target_path = File.join(archive_path, stat.ctime.strftime("%Y/%m %B"))
			if !File.exists?(target_path)
				FileUtils::mkdir_p(target_path)
			end
			FileUtils::mv(path, target_path)
			archived_files << filename
		end
	end
end

if archived_files.length > 0
	notifier = Growl.new("localhost", "cleanup-downloads", ["cleanup-downloads Notification"])
	notifier.notify "cleanup-downloads Notification", "Downloads", "#{archived_files.length} old downloads moved to archive"
end
